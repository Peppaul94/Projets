import csv
from datetime import datetime
import requests

def log_reader():
    file_path= r"C:\Users\20221292\Desktop\Projets\Python\auth_logs.txt"
    success = 0
    failed = 0
    with open(file_path, "r") as f:
            for line in f:
                log = line.strip()
                if "Authentication success:" in log:
                    success +=1
                elif "Authentication failed:" in log:
                    failed +=1
    return success, failed

def csvFile_reader():
    sensitive_set = {21, 22, 3389}
    results = []
    open_ports= []
    file_path = r"C:\Users\20221292\Desktop\Projets\Python\listOfOpenPort.csv"  # Chemin absolu du fichier CSV à lire
    with open(file_path, "r", encoding="utf-8") as f:  # Ouvre le fichier en lecture avec encodage UTF-8
        reader = csv.reader(f, delimiter=';')  # Initialise le lecteur CSV en utilisant ';' comme séparateur
        for row in reader:  # Parcourt chaque ligne du fichier CSV
            if not row or len(row) < 2:  # Ignore les lignes vides ou ne contenant pas au moins 2 colonnes
                continue
            ip = row[0].strip()  # Récupère l'adresse IP et supprime les espaces superflus
            ports_text = row[1].strip()  # Récupère la liste des ports (en texte) et supprime les espaces
            open_ports.append({"ip": ip, "ports": ports_text})
            if not ip or ip.lower() == "adresse ip":  # Ignore l'en-tête et les lignes sans adresse IP
                continue
            if not ports_text or ports_text.upper() == "N/A":
                continue
            raw_ports = [p.strip() for p in ports_text.split(',') if p.strip()]
            parsed_ports = []
            for p in raw_ports:
                try:
                    parsed_ports.append(int(p))
                except ValueError:
                    continue
            sensitive_found = sorted(set(parsed_ports) & sensitive_set)
            if sensitive_found:
                results.append({"ip": ip, "ports sensibles": sensitive_found})
    return ip, open_ports, results

def web_requester():
    sucessfullUrl= []
    failedUrl= []
    file_path = r"C:\Users\20221292\Desktop\Projets\Python\urls.txt"
    with open(file_path, 'r', encoding='utf-8') as file:
        try:
            for webUrl in file:
                webUrl = webUrl.strip()
                response = requests.get(webUrl, verify=False, timeout=5)
                result= response.status_code
                #data = response.text
                if result == 200:
                    sucessfullUrl.append(webUrl)
                else:
                    failedUrl.append(webUrl)
        except requests.exceptions.RequestException as e:
            failedUrl.append(webUrl)
    return sucessfullUrl, failedUrl

def rapport_generator(success, failed, ip, open_ports, results, sucessfullUrl, failedUrl):
    file_path = r"C:\Users\20221292\Desktop\Projets\Python\rapport_audit.txt"
    timestamp = datetime.now()
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(f"Rapport d'audit de sécurité - {timestamp.strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        f.write("Réaliser par Paul H.\n")
        f.write("\nAnalyse du fichier de journalisation:\n")
        f.write(f"Connexion réussie: {success}\n")
        f.write(f"Connexion échouée: {failed}\n")
        f.write("\nAnalyse des ports ouverts:\n")
        f.write(f"Adresse IP: {ip} | Port(s) ouvert(s): {open_ports}\n")
        f.write(f"Adresse IP: {ip} | Port(s) sensible(s) ouvert(s): {results}\n")
        f.write("\nAnalyse des URLs:\n")
        f.write("URL qui ont réussi: \n")
        for url in sucessfullUrl:
            f.write(url + "\n")
        f.write("\nURL qui ont échoué: \n")
        for url in failedUrl:
            f.write(url + "\n")

def main():
    print("--DEBUT DE L'AUDIT--")
    print("Analyse du fichier de journalisation...")
    try:
        success, failed = log_reader()
    except FileNotFoundError:
        print("Erreur: Le fichier de journalisation n'a pas été trouvé.")
        return
    print("Analyse des ports ouverts...")
    try:
        ip, open_ports, results = csvFile_reader()
    except FileNotFoundError:
        print("Erreur: Le fichier de liste des ports ouverts n'a pas été trouvé.")
        return
    print("Analyse des URLs...")
    try:
        sucessfullUrl, failedUrl = web_requester()
    except FileNotFoundError:
        print("Erreur: Le fichier de liste des URLs n'a pas été trouvé.")
        return
    print("Génération du rapport...")
    try:
        rapport_generator(success, failed, ip, open_ports, results, sucessfullUrl, failedUrl)
    except Exception as e:
        print(f"Erreur lors de la génération du rapport: {e}")
        return
    print("--FIN DE L'AUDIT--")

main()